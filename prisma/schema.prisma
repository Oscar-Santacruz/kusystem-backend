generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        BigInt   @id @default(autoincrement())
  name      String
  slug      String?  @unique
  logoUrl   String?
  createdByUserId String?
  createdBy User?   @relation("Tenant_createdByUserId", fields: [createdByUserId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clients   Client[]
  branches  ClientBranch[]
  products  Product[]
  quotes    Quote[]
  items     QuoteItem[]
  charges   QuoteAdditionalCharge[]
  employees Employee[]
  employeeSchedules EmployeeSchedule[]
  employeeAdvances EmployeeAdvance[]
  employeeSalaryHistory EmployeeSalaryHistory[]
  quoteStatusHistory QuoteStatusHistory[]

  memberships Membership[]
  invitations Invitation[]
  rolePermissions RolePermission[]
}

model User {
  id             String   @id @default(cuid())
  authProviderId String   @unique // Auth0 sub
  email          String   @unique
  name           String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  memberships Membership[]
  createdTenants Tenant[] @relation("Tenant_createdByUserId")
  createdInvitations Invitation[] @relation("Invitation_createdByUser")
}

model Membership {
  id            String   @id @default(cuid())
  userId        String
  tenantId      BigInt
  role          String   @db.VarChar(20) // 'owner' | 'admin' | 'member'
  createdAt     DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
}

model Invitation {
  id         String   @id @default(cuid())
  tenantId   BigInt
  email      String
  role       String   @db.VarChar(20)
  token      String   @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdByUserId String
  createdAt  DateTime @default(now())

  tenant  Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User @relation("Invitation_createdByUser", fields: [createdByUserId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([email])
}

model Client {
  id        String         @id @default(cuid())
  name      String
  taxId     String?        @db.VarChar(100)
  phone     String?        @db.VarChar(100)
  email     String?        @db.VarChar(200)
  branches  ClientBranch[]
  quotes    Quote[]        @relation("ClientQuotes")
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  tenantId  BigInt
  tenant    Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@unique([tenantId, taxId])
}

model ClientBranch {
  id        String   @id @default(cuid())
  clientId  String
  name      String
  address   String?
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  quotes    Quote[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId  BigInt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model Product {
  id          String   @id @default(cuid())
  sku         String?  @db.VarChar(100)
  name        String
  description String?
  barcode     String?  @db.VarChar(100)
  unit        String?  @db.VarChar(50)
  price       Decimal  @db.Decimal(18, 2)
  cost        Decimal? @db.Decimal(18, 2)
  taxRate     Decimal? @db.Decimal(5, 4)
  priceIncludesTax Boolean @default(false)
  stock       Decimal? @db.Decimal(18, 2)
  minStock    Decimal? @db.Decimal(18, 2)
  imageUrl    String?
  items       QuoteItem[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantId  BigInt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@unique([tenantId, sku])
}

model Quote {
  id            String      @id @default(cuid())
  number        String?     @default(dbgenerated("nextval('quote_number_seq')::text"))
  status        String?     @db.VarChar(20)
  customerId    String?
  customerName  String
  // Sucursal seleccionada para el presupuesto
  branchId      String?
  branchName    String?
  issueDate     DateTime?
  dueDate       DateTime?
  currency      String?     @db.VarChar(10)
  notes         String?
  // Mostrar notas en impresión/PDF
  printNotes    Boolean?    @default(true)
  // Enlace público
  publicId      String?     @unique @default(uuid())
  publicEnabled Boolean     @default(false)
  items         QuoteItem[]
  additionalCharges QuoteAdditionalCharge[]
  statusHistory QuoteStatusHistory[]
  subtotal      Decimal?    @db.Decimal(18, 2)
  taxTotal      Decimal?    @db.Decimal(18, 2)
  discountTotal Decimal?    @db.Decimal(18, 2)
  total         Decimal?    @db.Decimal(18, 2)
  customer      Client?     @relation("ClientQuotes", fields: [customerId], references: [id], onDelete: SetNull)
  branch        ClientBranch? @relation(fields: [branchId], references: [id], onDelete: SetNull)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  tenantId      BigInt
  tenant        Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@unique([tenantId, number])
}

model QuoteItem {
  id          String   @id @default(cuid())
  quoteId     String
  productId   String?
  description String
  quantity    Decimal  @db.Decimal(18, 2)
  unit        String?  @db.VarChar(50)
  unitPrice   Decimal  @db.Decimal(18, 2)
  discount    Decimal? @db.Decimal(18, 2)
  taxRate     Decimal? @db.Decimal(5, 4)
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  product     Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  tenantId    BigInt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model QuoteAdditionalCharge {
  id       String  @id @default(cuid())
  quoteId  String
  type     String
  amount   Decimal @db.Decimal(18, 2)
  quote    Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  tenantId BigInt
  tenant   Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model QuoteStatusHistory {
  id         String   @id @default(cuid())
  quoteId    String
  quote      Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  fromStatus String?  @db.VarChar(20)
  toStatus   String   @db.VarChar(20)
  reason     String?  // Motivo del cambio
  changedBy  String?  // Usuario que hizo el cambio (email o nombre)
  changedAt  DateTime @default(now())
  tenantId   BigInt
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([tenantId])
}

enum DayType {
  LABORAL
  AUSENTE
  LIBRE
  NO_LABORAL
  FERIADO
}

model Employee {
  id                String   @id @default(cuid())
  tenantId          BigInt
  firstName         String
  lastName          String
  email             String?  @db.VarChar(200)
  phone             String?  @db.VarChar(50)
  avatarUrl         String?
  department        String?  @db.VarChar(50)
  monthlySalary     Decimal? @db.Decimal(18, 2)
  defaultShiftStart String?  @db.VarChar(5)
  defaultShiftEnd   String?  @db.VarChar(5)
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant      Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  schedules   EmployeeSchedule[]
  advances    EmployeeAdvance[]
  salaries    EmployeeSalaryHistory[]

  @@index([tenantId])
  @@index([tenantId, department])
}

model EmployeeSchedule {
  id             String   @id @default(cuid())
  tenantId       BigInt
  employeeId     String
  date           DateTime @db.Date
  clockIn        String?  @db.VarChar(5)
  clockOut       String?  @db.VarChar(5)
  overtimeMinutes Int     @default(0)
  dayType        DayType  @default(LABORAL)
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  advances EmployeeAdvance[]

  @@unique([tenantId, employeeId, date])
  @@index([tenantId, date])
}

model EmployeeAdvance {
  id         String   @id @default(cuid())
  tenantId   BigInt
  employeeId String
  scheduleId String?
  amount     Decimal  @db.Decimal(18, 2)
  currency   String   @default("PYG") @db.VarChar(10)
  reason     String?
  issuedAt   DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant   Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  schedule EmployeeSchedule?  @relation(fields: [scheduleId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([employeeId])
  @@index([scheduleId])
}

model EmployeeSalaryHistory {
  id            String   @id @default(cuid())
  tenantId      BigInt
  employeeId    String
  monthlySalary Decimal  @db.Decimal(18, 2)
  effectiveFrom DateTime
  effectiveTo   DateTime?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([employeeId])
}

model Permission {
  id          String   @id @default(cuid())
  resource    String
  action      String
  description String?
  createdAt   DateTime @default(now())

  rolePermissions RolePermission[]

  @@unique([resource, action])
  @@index([resource])
}

model RolePermission {
  id           String     @id @default(cuid())
  tenantId     BigInt
  role         String     @db.VarChar(20)
  permissionId String
  createdAt    DateTime   @default(now())

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([tenantId, role, permissionId])
  @@index([tenantId, role])
}
